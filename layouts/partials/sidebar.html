{{/* themes/KidiVerse/layouts/partials/sidebar.html */}}
{{- define "listPagesRecursively" -}}
  {{- if .Pages -}}
    <ul class="sidebar-list sidebar-sublist">
      {{- range .Pages.ByTitle -}}
        {{- $isSection := or (gt (len .Pages) 0) (eq .Kind "section") -}}
        <li class="sidebar-item">
          {{- if $isSection -}}
            <div class="sidebar-folder">
              <div class="sidebar-folder-header">
                <svg class="folder-icon" viewBox="0 0 24 24" width="16" height="16">
                  <path d="M9 18l6-6-6-6"/>
                </svg>
                <span class="sidebar-folder-toggle">
                  {{- if .Title -}}
                    {{ .Title }}
                  {{- else -}}
                    {{- with .File -}}
                      {{ path.Base .Path | replaceRE "_index\\.md$" "" | replaceRE "\\.md$" "" }}
                    {{- else -}}
                      {{ .Name | humanize | title }}
                    {{- end -}}
                  {{- end -}}
                </span>
              </div>
              <div class="sidebar-folder-content">
                {{ template "listPagesRecursively" . }}
              </div>
            </div>
          {{- else -}}
            <a href="{{ .RelPermalink }}" class="sidebar-link{{ if eq .RelPermalink $.RelPermalink }} active{{ end }}">
              {{- with .File -}}
                {{ path.Base .Path | replaceRE "\\.md$" "" }}
              {{- else -}}
                {{ .Title }}
              {{- end -}}
            </a>
          {{- end -}}
        </li>
      {{- end -}}
    </ul>
  {{- end -}}
{{- end -}}

<nav class="sidebar-nav">
  <h2 class="sidebar-title">Explore</h2>
  <ul class="sidebar-list sidebar-list--root">
    {{- range .Site.Sections.ByTitle -}}
      <li class="sidebar-item sidebar-item--section">
        <div class="sidebar-folder">
          <div class="sidebar-folder-header">
            <svg class="folder-icon" viewBox="0 0 24 24" width="16" height="16">
              <path d="M9 18l6-6-6-6"/>
            </svg>
            <span class="sidebar-folder-toggle">
              {{- with .File -}}
                {{ path.Base .Path | replaceRE "\\.md$" "" }}
              {{- else -}}
                {{ .Title }}
              {{- end -}}
            </span>
          </div>
          <div class="sidebar-folder-content">
            {{ template "listPagesRecursively" . }}
          </div>
        </div>
      </li>
    {{- end -}}
  </ul>
</nav>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Handle folder toggles
  document.querySelectorAll('.sidebar-folder-header').forEach(header => {
    const toggle = header.querySelector('.sidebar-folder-toggle');
    const folder = header.closest('.sidebar-folder');
    const content = folder.querySelector('.sidebar-folder-content');
    const icon = header.querySelector('.folder-icon');
    
    // Load saved state or default to collapsed
    const isExpanded = localStorage.getItem(`folder-${toggle.textContent.trim()}`) === 'true';
    
    // Set initial state
    if (isExpanded) {
      content.style.display = 'block';
      icon.style.transform = 'rotate(90deg)';
    } else {
      content.style.display = 'none';
      icon.style.transform = 'rotate(0deg)';
    }
    
    // Toggle on header click
    header.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      
      if (content.style.display === 'none') {
        content.style.display = 'block';
        icon.style.transform = 'rotate(90deg)';
        localStorage.setItem(`folder-${toggle.textContent.trim()}`, 'true');
      } else {
        content.style.display = 'none';
        icon.style.transform = 'rotate(0deg)';
        localStorage.setItem(`folder-${toggle.textContent.trim()}`, 'false');
      }
    });
  });
});
</script>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const folderToggles = document.querySelectorAll('.sidebar-folder-toggle');
    
    function toggleFolder(toggle) {
      const parent = toggle.closest('.sidebar-folder');
      const sublist = parent.querySelector('> .sidebar-sublist');
      if (!sublist) return;
      
      const isHidden = sublist.style.display === 'none';
      sublist.style.display = isHidden ? 'block' : 'none';
      const icon = toggle.querySelector('.folder-icon');
      if (icon) {
        icon.style.transform = isHidden ? 'rotate(0)' : 'rotate(-90deg)';
      }
      
      // Save state in localStorage
      const path = toggle.querySelector('a')?.getAttribute('href') || '';
      if (path) {
        localStorage.setItem(`sidebar-${path}`, isHidden ? 'expanded' : 'collapsed');
      }
    }
    
    folderToggles.forEach(toggle => {
      const parent = toggle.closest('.sidebar-folder');
      const sublist = parent.querySelector('> .sidebar-sublist');
      
      if (sublist) {
        // Initialize state from localStorage
        const path = toggle.querySelector('a')?.getAttribute('href') || '';
        const savedState = path ? localStorage.getItem(`sidebar-${path}`) : null;
        
        // Set initial state
        if (savedState === 'collapsed') {
          sublist.style.display = 'none';
          const icon = toggle.querySelector('.folder-icon');
          if (icon) icon.style.transform = 'rotate(-90deg)';
        } else {
          sublist.style.display = 'block';
        }
        
        // Add click handler
        toggle.addEventListener('click', (e) => {
          // Only toggle if not clicking on a link
          if (e.target.tagName !== 'A') {
            e.preventDefault();
            toggleFolder(toggle);
          }
        });
      }
    });
    
    // Close all folders by default if none were previously saved
    if (!localStorage.getItem('sidebar-initialized')) {
      folderToggles.forEach(toggle => {
        const parent = toggle.closest('.sidebar-folder');
        const sublist = parent?.querySelector('> .sidebar-sublist');
        if (sublist && !sublist.style.display) {
          toggleFolder(toggle);
        }
      });
      localStorage.setItem('sidebar-initialized', 'true');
    }
  });
</script>
