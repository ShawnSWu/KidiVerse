{{ define "main" }}
  <article class="post-article">
    <div class="dashboard-content">
      <a href="{{ "about/" | relURL }}" class="galaxy-btn" id="planetAbout" title="About KidiVerse">
        <div class="galaxy-arms">
          <div class="arm arm1"></div>
          <div class="arm arm2"></div>
          <div class="arm arm3"></div>
        </div>
        <div class="galaxy-stars">
          {{ range seq 30 }}<span class="star"></span>{{ end }}
          <span class="special-star"></span>
        </div>
      </a>
      <div class="planet-overlay"></div>
      <div class="welcome-header">
        <div class="welcome-flex">
          <div class="avatar-container">
            <img src="{{ "/images/astronaut-icon.png" | relURL }}" alt="Astronaut avatar" class="avatar-image">
          </div>
          <div class="welcome-text">
            <h1>{{ .Site.Params.welcomeMessage | default "Welcome," }} {{ .Site.Params.userName | default "Explorer" }}</h1>
            <p class="welcome-tagline">{{ .Site.Params.description | default "Explore my knowledge universe" }}</p>
          </div>
          <div class="stats-box">
            <div class="stats-item">
              <div class="stats-label">All Notes</div>
              <div class="stats-value" id="total-md-count">{{ len .Site.RegularPages }}</div>
            </div>
            <div class="stats-item">
              <div class="stats-label">Graph Nodes</div>
              <div class="stats-value" id="total-graph-count">--</div>
            </div>
          </div>
        </div>
      </div>

      <div class="knowledge-section">
        <h2>Knowledge Graph</h2>
        <div class="graph-container">
          <div class="graph-visualization">
            <svg id="knowledge-graph" width="100%" height="100%"></svg>
          </div>
        </div>
      </div>

    </div>
  </article>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const planetAbout = document.getElementById('planetAbout');
      if (planetAbout) {
        planetAbout.addEventListener('click', function(e) {
          e.preventDefault();
          document.body.classList.add('zooming-out');
          setTimeout(() => {
            window.location.href = this.href;
          }, 800);
        });
      }

      async function loadGraphData() {
        const dataPath = '{{ "data/notes_graph.json" | absURL }}';
        try {
          // 嘗試多種可能的路徑，確保在開發和生產環境都能找到檔案
          const possiblePaths = [
            '/KidiVerse/data/notes_graph.json',  // GitHub Pages 路徑
            '/data/notes_graph.json',            // 根目錄路徑
            'data/notes_graph.json',             // 相對路徑
            '{{ "data/notes_graph.json" | absURL }}'  // 使用 Hugo 的 absURL 函數
          ];
          
          let lastError = null;
          
          // 嘗試每個可能的路徑，直到成功為止
          for (const path of possiblePaths) {
            try {
              console.log('Attempting to load graph data from:', path);
              const response = await fetch(path, {
                cache: 'no-cache',
                headers: {
                  'Cache-Control': 'no-cache, no-store, must-revalidate',
                  'Pragma': 'no-cache',
                  'Expires': '0'
                }
              });
              
              if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
              }
              
              const graphData = await response.json();
              console.log('Graph data loaded successfully from:', path);
              
              // 確保資料格式正確
              window.graphData = {
                nodes: Array.isArray(graphData.nodes) ? graphData.nodes : [],
                links: Array.isArray(graphData.links) ? graphData.links : []
              };
              
              console.log('Processed graph data:', { 
                nodes: window.graphData.nodes.length,
                links: window.graphData.links.length,
                sampleNode: window.graphData.nodes[0],
                sampleLink: window.graphData.links[0]
              });
              
              // 初始化圖表
              if (typeof initGraph === 'function') {
                initGraph();
              }
              
              return; // 如果成功載入，則直接返回
              
            } catch (error) {
              console.warn(`Failed to load from ${path}:`, error.message);
              lastError = error;
              continue; // 嘗試下一個路徑
            }
          }
          
          // 如果所有路徑都失敗，拋出最後一個錯誤
          throw lastError || new Error('No valid path found for graph data');

          
        } catch (error) {
          console.error('Error loading graph data:', error);
          
          // 顯示用戶友好的錯誤訊息
          const errorContainer = document.createElement('div');
          errorContainer.style.padding = '1rem';
          errorContainer.style.backgroundColor = '#ffebee';
          errorContainer.style.borderLeft = '4px solid #f44336';
          errorContainer.style.margin = '1rem 0';
          errorContainer.innerHTML = `
            <h3 style="margin: 0 0 0.5rem 0; color: #d32f2f;">無法載入知識圖譜</h3>
            <p style="margin: 0;">錯誤: ${error.message}</p>
            <p style="margin: 0.5rem 0 0 0; font-size: 0.9em; color: #666;">
              請稍後再試，或聯絡管理員。
            </p>
          `;
          
          // 將錯誤訊息插入到圖表容器中
          const graphContainer = document.querySelector('.graph-container');
          if (graphContainer) {
            graphContainer.prepend(errorContainer);
          }
          
          // 使用空資料初始化圖表
          window.graphData = { nodes: [], links: [] };
          if (typeof initGraph === 'function') {
            initGraph();
          }
        }
      }

      loadGraphData();
    });
  </script>

  <!-- D3.js Library -->
  <script src="https://d3js.org/d3.v7.min.js"></script>

{{ end }}
